!function(r,t){"use strict";function n(r){for(var t=0;t<h.length;t++)if(h[t](r))return a.isRegExp(r)?{$regex:r}:{$eq:r};if(a.isObject(r)){var n=a.keys(r),e=0===a.intersection(x.queryOperators,n).length;if(e)return{$eq:r};if(a.contains(n,"$regex")){var i=r.$regex,o=r.$options||"",u="";a.isString(i)&&(u+=i.ignoreCase||o.indexOf("i")>=0?"i":"",u+=i.multiline||o.indexOf("m")>=0?"m":"",u+=i.global||o.indexOf("g")>=0?"g":"",i=new RegExp(i,u)),r.$regex=i,delete r.$options}}return r}function e(r,t){return a.result(r,t)}function i(r,n){if(!n)return t;for(var o,u=n.split("."),s=r,c=0;c<u.length;c++){if(o=null===u[c].match(/^\d+$/),o&&a.isArray(s)){var f=[];a.each(s,function(r){a.isObject(r)&&f.push(i(r,u[c]))}),s=f}else s=e(s,u[c]);if(s===t)break}return s}function o(r,n,e){if(a.contains(x.groupOperators,n))return m[n](r,e);if(a.isObject(e)){var i={};for(var u in e)if(e.hasOwnProperty(u)&&(i[u]=o(r,u,e[u]),a.contains(x.groupOperators,u))){if(i=i[u],a.keys(e).length>1)throw new Error("Invalid $group expression '"+JSON.stringify(e)+"'");break}return i}return t}function u(r,t,n){if(a.contains(x.aggregateOperators,n))return _[n](r,t);if(a.isString(t)&&t.length>0&&"$"===t[0])return i(r,t.slice(1));var e;if(a.isArray(t)){e=[];for(var o=0;o<t.length;o++)e.push(u(r,t[o],null))}else if(a.isObject(t)){e={};for(var s in t)if(t.hasOwnProperty(s)&&(e[s]=u(r,t[s],s),a.contains(x.aggregateOperators,s))){if(e=e[s],a.keys(t).length>1)throw new Error("Invalid aggregation expression '"+JSON.stringify(t)+"'");break}}else for(var o=0;o<h.length;o++)if(h[o](t))return t;return e}var s,a,c={};null!=r&&(s=r.Mingo),c.noConflict=function(){return r.Mingo=s,c};var f="undefined"!=typeof exports&&"undefined"!=typeof require;f?(exports="undefined"!=typeof module&&module.exports?module.exports=c:c,a=require("underscore")):(r.Mingo=c,a=r._);var h=[a.isString,a.isBoolean,a.isNumber,a.isDate,a.isNull,a.isRegExp],l={key:"_id"};if(c.setup=function(r){a.extend(l,r||{})},c.Query=function(r,t){return this instanceof c.Query?(this._criteria=r,this._projection=t,this._compiled=[],void this._compile()):new c.Query(r,t)},c.Query.prototype={_compile:function(){if(!a.isEmpty(this._criteria)){if(a.isArray(this._criteria)||a.isFunction(this._criteria)||!a.isObject(this._criteria))throw new Error("Invalid type for criteria");for(var r in this._criteria)if(this._criteria.hasOwnProperty(r)){var t=this._criteria[r];if(a.contains(x.compoundOperators,r)){if(a.contains(["$not"],r))throw new Error("Invalid operator");this._processOperator(r,r,t)}else{t=n(t);for(var e in t)t.hasOwnProperty(e)&&this._processOperator(r,e,t[e])}}}},_processOperator:function(r,t,n){var e;if(a.contains(x.simpleOperators,t))e={test:function(e){var o=i(e,r);return $[t](o,n)}};else{if(!a.contains(x.compoundOperators,t))throw new Error("Invalid query operator '"+t+"' detected");e=v[t](r,n)}this._compiled.push(e)},test:function(r){for(var t=0;t<this._compiled.length;t++)if(!this._compiled[t].test(r))return!1;return!0},find:function(r,t){return new c.Cursor(r,this,t)},remove:function(r){for(var t=[],n=0;n<r.length;n++)this.test(r[n])||t.push(r[n]);return t}},f){var p=require("stream").Transform,g=require("util");c.Query.prototype.stream=function(r){return new c.Stream(this,r)},c.Stream=function(r,t){return this instanceof c.Stream?(t=t||{},a.extend(t,{objectMode:!0}),p.call(this,t),void(this._query=r)):new c.Stream(r,t)},g.inherits(c.Stream,p),c.Stream.prototype._transform=function(r,t,n){if(a.isObject(r)&&this._query.test(r))if(a.isEmpty(this._query._projection))this.push(r);else{var e=new c.Cursor([r],this._query);e.hasNext()&&this.push(e.next())}n()}}c.Cursor=function(r,t,n){return this instanceof c.Cursor?(this._query=t,this._collection=r,this._projection=n||t._projection,this._operators={},this._result=!1,void(this._position=0)):new c.Cursor(r,t,n)},c.Cursor.prototype={_fetch:function(){var r=this;if(this._result!==!1)return this._result;if(a.isObject(this._projection)&&a.extend(this._operators,{$project:this._projection}),!a.isArray(this._collection))throw new Error("Input collection is not of valid type. Must be an Array.");this._result=a.filter(this._collection,this._query.test,this._query);var t=[];if(a.each(["$sort","$skip","$limit","$project"],function(n){a.has(r._operators,n)&&t.push(a.pick(r._operators,n))}),t.length>0){var n=new c.Aggregator(t);this._result=n.run(this._result,this._query)}return this._result},all:function(){return this._fetch()},first:function(){return this.count()>0?this._fetch()[0]:null},last:function(){return this.count()>0?this._fetch()[this.count()-1]:null},count:function(){return this._fetch().length},skip:function(r){return a.extend(this._operators,{$skip:r}),this},limit:function(r){return a.extend(this._operators,{$limit:r}),this},sort:function(r){return a.extend(this._operators,{$sort:r}),this},next:function(){return this.hasNext()?this._fetch()[this._position++]:null},hasNext:function(){return this.count()>this._position},max:function(r){return m.$max(this._fetch(),r)},min:function(r){return m.$min(this._fetch(),r)},map:function(r){return a.map(this._fetch(),r)},forEach:function(r){a.each(this._fetch(),r)}},c.Aggregator=function(r){return this instanceof c.Aggregator?void(this._operators=r):new c.Aggregator(r)},c.Aggregator.prototype={run:function(r,t){if(!a.isEmpty(this._operators))for(var n=0;n<this._operators.length;n++){var e=this._operators[n];for(var i in e)e.hasOwnProperty(i)&&(r=t instanceof c.Query?y[i].call(t,r,e[i]):y[i](r,e[i]))}return r}},c.find=function(r,t,n){return new c.Query(t).find(r,n)},c.remove=function(r,t){return new c.Query(t).remove(r)},c.aggregate=function(r,t){if(!a.isArray(t))throw new Error("Aggregation pipeline must be an array");return new c.Aggregator(t).run(r)},c.CollectionMixin={query:function(r,t){return c.find(this.toJSON(),r,t)},aggregate:function(r){var t=[this.toJSON(),r];return c.aggregate.apply(null,t)}};var y={$group:function(r,t){var n=t[l.key],e=[],i=a.groupBy(r,function(r){var t=u(r,n,n);return e.push(t),t});e=a.uniq(e),t=a.omit(t,l.key);var s=[];return a.each(e,function(r){var n={};n[l.key]=r;for(var e in t)t.hasOwnProperty(e)&&(n[e]=o(i[r],e,t[e]));s.push(n)}),s},$match:function(r,t){return new c.Query(t).find(r).all()},$project:function(r,n){if(a.isEmpty(n))return r;var e=[],i=a.keys(n);if(a.contains(i,l.key)){var o=n[l.key];(0===o||o===!1)&&(i=a.without(i,l.key))}else i.push(l.key);for(var s=0;s<r.length;s++){var c=r[s],f={};a.each(i,function(r){var e,i=n[r];if(r===l.key&&a.isEmpty(i))e=c[r];else if(a.isString(i))e=u(c,i,r);else if(1===i||i===!0)e=a.result(c,r);else if(a.isObject(i)){var o=a.keys(i);if(o=o.length>1?!1:o[0],o!==!1&&a.contains(x.projectionOperators,o)){var s=d[o](c,i[o],r);a.isUndefined(s)||(e=s)}else e=u(c,i,r)}e!==t&&(f[r]=a.isObject(e)?a.clone(e):e)}),e.push(f)}return e},$limit:function(r,t){return a.first(r,t)},$skip:function(r,t){return a.rest(r,t)},$unwind:function(r,t){for(var n=[],i=t.substr(1),o=0;o<r.length;o++){var u=r[o],s=e(u,i);if(!a.isArray(s))throw new Error("Target field '"+i+"' is not of type Array.");a.each(s,function(r){var t=a.clone(u);t[i]=r,n.push(t)})}return n},$sort:function(r,t){if(!a.isEmpty(t)&&a.isObject(t)){var n=a.keys(t);n.reverse().forEach(function(n){var e=[],o=a.groupBy(r,function(r){var t=i(r,n);return e.push(t),t});e=a.sortBy(a.uniq(e),function(r){return r}),-1===t[n]&&e.reverse(),r=[],a.each(e,function(t){Array.prototype.push.apply(r,o[t])})})}return r}},v={$and:function(r,t){if(!a.isArray(t))throw new Error("Invalid expression for $and criteria");var n=[];return a.each(t,function(r){n.push(new c.Query(r))}),{test:function(r){for(var t=0;t<n.length;t++)if(!n[t].test(r))return!1;return!0}}},$or:function(r,t){if(!a.isArray(t))throw new Error("Invalid expression for $or criteria");var n=[];return a.each(t,function(r){n.push(new c.Query(r))}),{test:function(r){for(var t=0;t<n.length;t++)if(n[t].test(r))return!0;return!1}}},$nor:function(r,t){if(!a.isArray(t))throw new Error("Invalid expression for $nor criteria");var n=this.$or("$or",t);return{test:function(r){return!n.test(r)}}},$not:function(r,t){var e={};e[r]=n(t);var i=new c.Query(e);return{test:function(r){return!i.test(r)}}},$where:function(r,t){return a.isFunction(t)||(t=new Function("return "+t+";")),{test:function(r){return t.call(r)===!0}}}},$={$eq:function(r,n){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return a.isEqual(r,n)}),r!==t},$ne:function(r,t){return!this.$eq(r,t)},$in:function(r,t){return r=a.isArray(r)?r:[r],a.intersection(r,t).length>0},$nin:function(r,t){return a.isUndefined(r)||!this.$in(r,t)},$lt:function(r,n){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return n>r}),r!==t},$lte:function(r,n){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return n>=r}),r!==t},$gt:function(r,n){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return r>n}),r!==t},$gte:function(r,n){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return r>=n}),r!==t},$mod:function(r,n){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return a.isNumber(r)&&a.isArray(n)&&2===n.length&&r%n[0]===n[1]}),r!==t},$regex:function(r,n){return r=a.isArray(r)?r:[r],r=a.find(r,function(r){return a.isString(r)&&a.isRegExp(n)&&!!r.match(n)}),r!==t},$exists:function(r,t){return t===!1&&a.isUndefined(r)||t===!0&&!a.isUndefined(r)},$all:function(r,t){var n=this,e=!1;if(a.isArray(r)&&a.isArray(t))for(var i=0;i<t.length;i++){if(!a.isObject(t[i])||!a.contains(a.keys(t[i]),"$elemMatch"))return a.intersection(t,r).length===t.length;e=e||n.$elemMatch(r,t[i].$elemMatch)}return e},$size:function(r,t){return a.isArray(r)&&a.isNumber(t)&&r.length===t},$elemMatch:function(r,t){if(a.isArray(r)&&!a.isEmpty(r))for(var n=new c.Query(t),e=0;e<r.length;e++)if(n.test(r[e]))return!0;return!1},$type:function(r,t){switch(t){case 1:return a.isNumeric(r)&&-1!==(r+"").indexOf(".");case 2:case 5:return a.isString(r);case 3:return a.isObject(r);case 4:return a.isArray(r);case 8:return a.isBoolean(r);case 9:return a.isDate(r);case 10:return a.isNull(r);case 11:return a.isRegExp(r);case 16:return a.isNumeric(r)&&2147483647>=r&&-1===(r+"").indexOf(".");case 18:return a.isNumeric(r)&&r>2147483647&&0x8000000000000000>=r&&-1===(r+"").indexOf(".");default:return!1}}},d={$:function(){throw new Error("$ not implemented")},$elemMatch:function(r,n,e){var o=i(r,e),u=new c.Query(n);if(a.isUndefined(o)||!a.isArray(o))return t;for(var s=0;s<o.length;s++)if(u.test(o[s]))return o[s];return t},$slice:function(r,n,e){var o=i(r,e);return a.isUndefined(o)?t:(a.isArray(n)||(n=[n]),Array.prototype.slice.apply(o,n))}},m={$addToSet:function(r,t){var n=a.map(r,function(r){return u(r,t)});return a.uniq(n)},$sum:function(r,t){return a.isNumber(t)?r.length*t:a.reduce(r,function(r,n){return r+u(n,t)},0)},$max:function(r,t){var n=a.max(r,function(r){return u(r,t)});return u(n,t)},$min:function(r,t){var n=a.min(r,function(r){return u(r,t)});return u(n,t)},$avg:function(r,t){return this.$sum(r,t)/r.length},$push:function(r,t){return a.map(r,function(r){return u(r,t)})},$first:function(r,n){return r.length>0?u(r[0],n):t},$last:function(r,n){return r.length>0?u(r[r.length-1],n):t}},_={$add:function(r,t){var n=u(r,t);return a.reduce(n,function(r,t){return r+t},0)},$subtract:function(r,t){var n=u(r,t);return n[0]-n[1]},$divide:function(r,t){var n=u(r,t);return n[0]/n[1]},$multiply:function(r,t){var n=u(r,t);return a.reduce(n,function(r,t){return r*t},1)},$mod:function(r,t){var n=u(r,t);return n[0]%n[1]},$cmp:function(r,t){var n=u(r,t);return n[0]>n[1]?1:n[0]<n[1]?-1:0},$concat:function(r,n){var e=u(r,n);return a.contains(e,null)||a.contains(e,t)?null:e.join("")},$strcasecmp:function(r,t){var n=u(r,t);return n[0]=a.isEmpty(n[0])?"":n[0].toUpperCase(),n[1]=a.isEmpty(n[1])?"":n[1].toUpperCase(),n[0]>n[1]?1:n[0]<n[1]?-1:0},$substr:function(r,t){var n=u(r,t);return a.isString(n[0])?n[1]<0?"":n[2]<0?n[0].substr(n[1]):n[0].substr(n[1],n[2]):""},$toLower:function(r,t){var n=u(r,t);return a.isEmpty(n)?"":n.toLowerCase()},$toUpper:function(r,t){var n=u(r,t);return a.isEmpty(n)?"":n.toUpperCase()}},w={$setEquals:function(r,t){var n=u(r,t),e=a.uniq(n[0]),i=a.uniq(n[1]);return e.length!==i.length?!1:0==a.difference(e,i).length},$setIntersection:function(r,t){var n=u(r,t);return a.intersection(n[0],n[1])},$setDifference:function(r,t){var n=u(r,t);return a.difference(n[0],n[1])},$setUnion:function(r,t){var n=u(r,t);return a.union(n[0],n[1])},$setIsSubset:function(r,t){var n=u(r,t);return a.intersection(n[0],n[1]).length===n[0].length},$anyElementTrue:function(r,t){for(var n=u(r,t)[0],e=0;e<n.length;e++)if(n[e])return!0;return!1},$allElementsTrue:function(r,t){for(var n=u(r,t)[0],e=0;e<n.length;e++)if(!n[e])return!1;return!0}},O={$cond:function(r,t){var n,e,i;if(a.isArray(t)){if(3!=t.length)throw new Error("Invalid arguments for $cond operator");n=t[0],e=t[1],i=t[2]}else a.isObject(t)&&(n=t["if"],e=t.then,i=t["else"]);var o=u(r,n);return o?u(r,e):u(r,i)},$ifNull:function(r,n){if(!a.isArray(n)||2!=n.length)throw new Error("Invalid arguments for $ifNull operator");var e=u(r,n);return null===e[0]||e[0]===t?e[1]:e[0]}};a.each(["$eq","$ne","$gt","$gte","$lt","$lte"],function(r){_[r]=function(t,n){var e=u(t,n);return $[r](e[0],e[1])}}),a.extend(_,w,O);var x={simpleOperators:a.keys($),compoundOperators:a.keys(v),setOperators:a.keys(w),aggregateOperators:a.keys(_),groupOperators:a.keys(m),pipelineOperators:a.keys(y),projectionOperators:a.keys(d)};x.queryOperators=a.union(x.simpleOperators,x.compoundOperators)}(this);